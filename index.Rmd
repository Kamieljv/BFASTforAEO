---
title: "MODIS NDVI time series analysis using BFAST"
author: "Jan Verbesselt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  knitrBootstrap::bootstrap_document:
    theme: "simplex"
    highlight: Tomorrow Night Bright
    menu: FALSE
    theme.chooser: TRUE
    highlight.chooser: TRUE
---

# MODIS based time series analysis using BFAST

![WUR logo](http://www.wageningenur.nl/upload/f9a0b5f2-15c5-4b84-9e14-20ef02f5e265_wur-logo.png)

[Jan Verbesselt](http://www.wur.eu/changemonitor)

```{r, eval=TRUE, echo=TRUE, include=TRUE, results='asis'}
format(Sys.time(), '%d %B, %Y')
```

This document explains how to use R scripting language for downloading MODIS data and analysing it within R. The results of the analysis of MODIS data within R are illustrated. For this time series analysis demonstration it is not required to know R details, we only use R for some practical demonstration of its great potential. In this exercise we will automatically download MODIS data for specific locations around the world. 
First, MODIS satellite data is described. Second, the use of R is introduced. Finally, the exercise in R is explained, step by step. 

# Introduction to MODIS data and online analysis

The MODIS satellite data that we will download for this time series analysis exercise is available from [MODIS Subsetting Website](https://modis.ornl.gov/sites/). MODIS data is made available for speficic locations. 

More specifically, we will look at the MODIS product called MOD13Q1 which are global 16-day images at a spatial resolution of 250 m. Each image contains several bands; i.e. blue, red, and near-infrared reflectances, centered at 469-nanometers, 645-nanometers, and 858-nanometers, respectively, are used to determine the MODIS vegetation indices.

The MODIS Normalized Difference Vegetation Index (NDVI) complements NOAA's Advanced Very High Resolution Radiometer (AVHRR) NDVI products and provides continuity for time series historical applications. MODIS also includes a new Enhanced Vegetation Index (EVI) that minimises canopy background variations and maintains sensitivity over dense vegetation conditions. The EVI also uses the blue band to remove residual atmosphere contamination caused by smoke and sub-pixel thin clouds. The MODIS NDVI and EVI products are computed from atmospherically corrected bi-directional surface reflectances that have been masked for water, clouds, heavy aerosols, and cloud shadows.

Vegetation indices are used for global monitoring of vegetation conditions and are used in products displaying land cover and land cover changes. These data may be used as input for modeling global biogeochemical and hydrologic processes and global and regional climate. These data also may be used for characterizing land surface biophysical properties and processes, including primary production and land cover conversion.
We will work with the MODIS NDVI band within the MOD13Q1 product. More information about this MODIS data set can be found via the [MODIS product table](https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mod13q1_v006).


> **Question 1**: By what factor does the 250m MODIS NDVI image layer need to 
be multiplied in order to obtain values between 0 and 1?

> **Question 2**: What pixel reliability (i.e. rank number) would you use to obtain *good data*?

Tip: see the [MODIS user guide](https://lpdaac.usgs.gov/sites/default/files/public/product_documentation/mod13_user_guide.pdf) and search for the meaning of reliability.


Now go to the [MODIS Land Products](https://modis.ornl.gov/sites/):

  * Search for 'The Netherlands' and select the Gelderland Loobos Site.
  * select the MODIS 13Q1 product
  * here you can download the data manually but we will do that via a R script as explained below.
  * See the tab 'location' and see how the subset has been spatially defined. This will be important for the R script as explained below.
  
  * Now study the NDVI and EVI time series graphs:

> **Question 3**: What key differences do you observe between NDVI and EVI time series visualised on the bottom of the page?
Why do they differ?

> **Question 4**: What is the key land cover type in the center of the site? (see bottom left side of the website)

# Automated MODIS NDVI download and analysis via R

We will download the MODIS data for the Loobos Site via R and process the data for one location to detect changes within the time series.

Now if need you can follow the following tutorial on getting started with [R and Rstudio](https://geoscripting-wur.github.io/Scripting4GeoIntro/#Basic_R_and_RStudio_setup).


## Getting started: install packages and define functions for MODIS data analysis

Now we are ready to get started with the MODIS time series analysis exercise in R! 
First, choose your working directory (i.e. a folder on your hard drive) to which the MODIS data will be downloaded and where you will save your R script. Set your workdirectory in R using the `setwd()` command. Remark: on your computer the file path looks different on windows! In R you have to change the backslash symbol to a forward slash symbol e.g.: 
  
```{r, eval = FALSE}
## "d:\student\MODIS"
setwd(c("d:/student/MODIS/")) ## choose your own directory
getwd() ## to check what your working directory is.
```

Second, make sure your package installed in R are up-to-date by:

```{r, eval=FALSE, echo=TRUE}
update.packages(ask=FALSE)

## we install the latest bfast package from the R-forge website
install.packages("bfast", dependencies=TRUE)

## for mac users you can do
install.packages("bfast", 
                 dependencies=TRUE, type = "source")

```

The necessary add-on packages need to be installed within R before loading the using the `library()` function. Below we define a helper function that does installing and loading of the packages for us. 

```{r, echo=TRUE, message=FALSE, eval=TRUE}
# pkgTest is a helper function to load packages and install packages only when they are not installed yet.
pkgTest <- function(x)
{
  if (x %in% rownames(installed.packages()) == FALSE) {
    install.packages(x, dependencies= TRUE)    
  }
  library(x, character.only = TRUE)
}
neededPackages <- c("strucchange","forecast","zoo", "bfast")
for (package in neededPackages){pkgTest(package)}
```


The two functions defined in the section below need to be run at once (select all of them in the R script window and do **Crtl-Return**). 
This will define two functions which we will need to process the MODIS data time series. 
So nothing will happen now in R, but the function are loaded and ready to be used in the script sections below. 

> Note: you do not need to understand the details of the two functions below. 
Make sure you know how to use them. Understanding the details of the two functions below is only for advanced R users (so optional and not required for AEO!).

```{r}
## a function to create a regular "ts" (time series) object in R using time information (dt)
timeser <- function(index,dt) {
	z <- zoo(index,dt)
	yr <- as.numeric(format(time(z), "%Y"))
	jul <- as.numeric(format(time(z), "%j"))
	delta <- min(unlist(tapply(jul, yr, diff))) # 16
	zz <- aggregate(z, yr + (jul - 1) / delta / 23)
	(tso <- as.ts(zz))
	return(tso)	
}

## a function to remove values (set NA)
## that do not equal a certain criteria
sel <- function(y,crit){
	ts.sel <- y
	ts.sel[!crit] <- NA
	return(ts.sel)
}
```

## Downloading MODIS data using R script

Now we are ready to start downloading the MODIS data. We will use this approah via R as long as the server in the U.S. is online and working (you need internet connection, and also keep in mind that the file can be more than 15Mb large).

```{r, eval = FALSE}
getwd() ## the file is downloaded to your working directory 
```


```{r}
## now download the file only if the .csv file does not exist yet on your computer (check in your working directory for existing csv files!)

## then read the csv file using the 'read.csv' function
fluxtower <- "nl_gelderland_loobos_MOD13Q1"
filename <- paste("https://modis.ornl.gov/site/",fluxtower,"/MOD13Q1.csv",sep="")

# result of the paste function for loobos site"https://modis.ornl.gov/site/nl_gelderland_loobos_MOD13Q1/MOD13Q1.csv"

# define column names of the file the we will download
colnames <- c("HDFname","Product","Date","Location","ProcessDate","Band", 1:(1095-6))

modisfilename <- paste(fluxtower,".csv",sep="")
 if(!file.exists(modisfilename)) {
  download.file(filename,modisfilename) # download
	modis <- read.csv(modisfilename, header=FALSE, col.names=colnames)
} else {
	modis <- read.csv(modisfilename, header=FALSE, col.names=colnames) 
}

## if the above step does not work you can download the data manually via the website and name the file
## e.g. "nl_gelderland_loobos.csv" then read it in with 
## modis <- read.csv(fluxtower, header=FALSE, col.names=colnames)
```

By running the lines above the MODIS data subset for the Loobos fluxtower (the Netherlands) is downloaded to the`modis` variable. 
Data for a different fluxtower, a fluxtower in New South Wales, Australia, can be downloaded by changing the `fluxtower` variable using the following line:

```{r}
fluxtower <- c("au_newsouthwales_tumbarumba_MOD13Q1")
```

You can find this name via the following [link](https://modis.ornl.gov/cgi-bin/sites/site.pl?id=au_newsouthwales_tumbarumba&product=MOD13Q1). Then go to TAB **Subset Summary**, and then see **Site ID** information.

You can browser for other sites via:
[https://modis.ornl.gov/sites/](https://modis.ornl.gov/sites/)

Now try and change the name of the flux tower site and then rerun the section above to download data for another location in the world. 

## The MODIS CSV file data structure

The MODIS data within the 'modis'  variable is organised so that the first six columns of the file contain information
about filename, product (i.e. MOD13Q1), date (date of the image), Site (e.g. Loobos), Processdata, and band
(i.e. one MODIS image has different bands = LAYERS, e.g. NDVI). 

For More information about the data.frame file structure see: [data_format](https://modis.ornl.gov/documentation.html#data_format).

```{r}
str(modis[1,1:6])
```

The following R names() shows the names of the first 6 columns of the 'modis' data.frame containing all the data.

```{r}
names(modis)[1:8]
```

The first six columns contain info about the image (e.g. site, date, band, and when it is processed) and from the 7th each column contains e.g. NDVI information from each MODIS pixel within the subset. E.g the 7th column is a pixel, and the 8th is another pixel. 

The following R code line shows the band names of this file. The MOD13Q1 Product contains 12 Bands:
```{r}
modis$Band[1:12]
```

# Visualising modis time series above the fluxtower

## Plotting a MODIS NDVI time series

We select band 5 i.e. the NDVI band, and band 7 i.e. the band with reliability information

```{r}
ndvibandname <- modis$Band[5] 
rel <- modis$Band[7] 
```

We will select data for the pixel above the Loobos Fluxtower. Have a look at 
[LoobosSiteInfo](https://modis.ornl.gov/cgi-bin/sites/site.pl?id=nl_gelderland_loobos&product=MOD13Q1) and see the **Pixel Numbering Scheme**:

Center location is 545. Each column after the 6th column in the MODIS file contains data of one pixel 
so to select the data above the flux tower we have to add 6 to select the correct column within the matrix.
The code section below will select the MODIS data for one pixel, scale the NDVI data by dividing it by 10000,
and then plot the resulting variable `ts.NDVI` using the `plot()` function:

```{r}
j <- (545)+6 # we are adding 6 since the first data column is the 7th column  
reliability <- as.numeric(modis[modis$Band == rel, j]) # reliability data
NDVI <- as.numeric(modis[modis$Band == ndvibandname, j]) # NDVI data
DATUM <- modis[modis$Band == ndvibandname, 3] # dates
DATUM <- as.Date(DATUM,"A%Y%j") # convert to a datum type
```

Now, let's create a time series! The NDVI value need to be scaled between 0-1 by dividing them by 10000.
Attention! The `Zoo` package is needed within the `timeser` function so we load the package using the line below.


```{r, message=FALSE}
library(zoo) ## load the package
ts.rel <- timeser(reliability, DATUM)
ts.NDVI <- timeser(NDVI/10000, DATUM)
```

Now plot the resulting `ts.NDVI` object:

```{r, fig.width=20, fig.height=10}
plot(ts.NDVI, ylab = "NDVI") 
```

> **Question 5**: Below a code section is provided that you can use (copy/paste and customize). 
Select multiple pixels (e.g. 6 pixels) and derive an average, maximum, and median of the selected time series. 
Now make a plot showing the average, maximum, or median time series. 
Compare the median NDVI time series with the NDVI time series of the flux tower and copy paste the R plot output in your report. 
Which approach do you think would be suitable to reduce the noise within a time series? Explain why? 
For bonus points and an extra challenge: Try to derive a 'noise reduced' NDVI time series of a 3 by 3 window around the flux tower.


```{r, message=FALSE, warning=FALSE, fig.width=11, fig.height=6}
## try it out and customize for your own needs
j <- 442:444  # adjust the nummers or define your own pixels with e.g. j <- c(545,..)
t <- modis[modis$Band == ndvibandname, j] # extract NDVI data
tt <- data.matrix(t)/10000 ## convert to a data matrix and divide by 10000
ttt <- ts(apply(tt, 2, timeser, DATUM), start=c(2000,4), freq=23) 
## convert to a regular time series object
## plot(ttt) ## plot all the time series
## derive the statistics (max, mean):
maxt <- ts(apply(ttt, 1, max, na.rm=TRUE), start=c(2000,4), freq=23)
meant <- ts(apply(ttt, 1, mean, na.rm=TRUE), start=c(2000,4), freq=23)
## plot
plot(maxt, col="green", ylim=c(0,1))
lines(meant, col="red")
```


## Use the MODIS Reliability information to clean the NDVI time series

Now, we will visualize MODIS reliability information using the `sel` function defined above. 

The code section below plot a red point on the plot for all the data points in the time series with a reliability > 1. 
You can choose `ts.rel = 1`, or `ts.rel > 2`, or ..., and rerun the plot command again and see what happens.

```{r, warning=FALSE, fig.width=11, fig.height=6}
plot(ts.NDVI)
lines(sel(ts.NDVI,ts.rel > 1), col = "red", type = "p") 
legend("bottomleft","pixels with a low reliability",col=2,pch=1)
```

> **Question 6**: Investigation of MODIS reliability scores. What happens if you select only good quality NDVI data? Can you explain what happens and why this could be? Discuss.

Perform the cleaning and plot the result by running the following lines. The resulting plot will show the MODIS NDVI time series showing red section which indicate the zones that are deleted based on reliability information.

```{r}
ts.clNDVI <- ts.NDVI
ts.clNDVI[ts.rel > 1] <- NA  # delete data with reliability > 1
```

 
 By applying the two R script lines above, we set all the points with a reliability above 1 to NA (i.e. Not Available which is similar as deleting the value) in the *ts.clNDVI* variable. 
 Now, plot the result of the cleaning and compare with the non-cleaned time series:

```{r, fig.width=11, fig.height=6}
plot(ts.NDVI, col='red')
lines(ts.clNDVI, lwd=2, col='black')  
```

There are still cloud effects visible in the NDVI time series after using the MODIS reliability information. 
The reliability information available with each MODIS image indicates how reliable the data is and is based on the cloud masking results, atmospheric data (aerosol thickness), 
satellite viewing angle, etc. More information about the reliability is available via the [MODIS Product Table website](https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mod13q1_v006).

# Applying BFAST on cleaned NDVI time series

In this section we will use BFAST on the cleaned NDVI time series to detect changes within the time series. First, we will interpolate the gaps in the cleaned NDVI time series using a simple linear interpolation approach. The function that we use for this is the 'na.aprox()' function which looks for NA's (Not Available's), which means dates for which no data is available (e.g., that we removed in the previous steps) and interpolates the data. 
The `plot()` command of the results `ts.clNDVIfilled` visualizes the result of the interpolation.

```{r, fig.width=20, fig.height=10}
ts.clNDVIfilled <- na.approx(ts.clNDVI)
plot(ts.clNDVIfilled, ylim=c(0.1, 1))
```

Second, we apply the BFAST function onto the time series. We determine this minimum distance between potentially detected breaks. 
Here, we set the distance to 25 time steps (i.e. 25 16-day images). Then we apply the BFAST function (`bfast()`) on the time series..

```{r, eval=FALSE}
rdist <- 25/length(ts.clNDVIfilled)
## ratio of distance between breaks (time steps) and length of the time series
fit <- bfast(ts.clNDVIfilled, h=rdist,
             season="harmonic", max.iter=1)
plot(fit, main="")
```

> **Question 7**: copy  and paste the resulting R BFAST graph in the report and describe the detected components and change types, detected within the time series. Are there any detected breaks? How strict would you do the cleaning?

> **Question 8**: Download data from another location on earth and run all the steps mentioned above again in order to apply the BFAST function again onto a new cleaned NDVI time series. Copy the BFAST plot to your report, mention the flux tower that you downloaded the data from and describe the difference with the graph obtained from *Question 7*.

## Finding information and examples about BFAST

To better understand how BFAST works have a look at the help section of the BFAST function and try out the examples provided.

```{r, eval=FALSE}
help(bfast)
## for more info
## try out the examples in the bfast help section!
plot(harvest, ylab="NDVI") # MODIS 16-day cleaned and interpolated NDVI time series
(rdist <- 10/length(harvest))
# ratio of distance between breaks (time steps) and length of the time series
fit <- bfast(harvest, h=rdist, season="harmonic", max.iter=1, breaks=2)
plot(fit)
## plot anova and slope of the trend identified trend segments
plot(fit, main="")
```

# Applying BFASTmonitor on the cleaned NDVI time series

To better understand how bfastmonitor works have a look at the help section of the `bfastmonitor()` function and try out the examples provided.

```{r, eval = FALSE}
?bfastmonitor
```

Try also the following example on our MODIS data:

```{r, fig.width=12, fig.height=5}
mon <- bfastmonitor(ts.clNDVIfilled,
                    start = c(2016, 23),
                formula = response ~ harmon + trend,
                    history = "all")
plot(mon, main="bfastmonitor results")
```


> **Question 9**: Start the monitoring period the end of 2016. Is 2017 an abnormal year in your own time series?

> **Question 10**: See the help section of bfastmonitor. Can you explain what the effect is of using a different `formula` in `bfastmonitor()`. For example, what happens if you use `response ~ trend`. Illustrate this with your own time series for a location of your own choice.


# More information
More information can be found on the [BFAST website](http://bfast.r-forge.r-project.org/) and in the BFAST papers mentioned on the website.



<br><br>
<br><br>
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.



