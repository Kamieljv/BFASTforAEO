---
title: "MODIS NDVI time series analysis using BFAST"
author: "Jan Verbesselt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  knitrBootstrap::bootstrap_document:
    theme: "simplex"
    highlight: Tomorrow Night Bright
    menu: FALSE
    theme.chooser: TRUE
    highlight.chooser: TRUE
---

# MODIS based time series analysis using BFAST

![WUR logo](http://www.wur.nl/upload/b43b7095-e452-482a-8969-fed9a50393a8_WUR_RGB_standard.png)

[Jan Verbesselt](http://www.wur.eu/changemonitor)

```{r, eval=TRUE, echo=TRUE, include=TRUE, results='asis'}
format(Sys.time(), '%d %B, %Y')
```

This document explains how to use R scripting language for downloading MODIS data and analysing it within R. The results of the analysis of MODIS data within R are illustrated. For this time series analysis demonstration it is not required to know R details, we only use R for some practical demonstration of its great potential. In this exercise we will automatically download MODIS data for specific locations around the world. 
First, MODIS satellite data is described. Second, the use of R is introduced. Finally, the exercise in R is explained, step by step. 

# Introduction to MODIS data and online analysis

The MODIS satellite data that we will download for this time series analysis exercise is available from [MODIS Subsetting Website](https://modis.ornl.gov/sites/). MODIS data is made available for specific locations. 

More specifically, we will look at the MODIS product called MOD13Q1 which are *global 16-day images at a spatial resolution of 250 m*. Each image contains several bands; i.e. blue, red, and near-infrared reflectances, centered at 469-nanometers, 645-nanometers, and 858-nanometers, respectively, are used to determine the MODIS vegetation indices.

The MODIS Normalized Difference Vegetation Index (NDVI) complements NOAA's Advanced Very High Resolution Radiometer (AVHRR) NDVI products and provides continuity for time series historical applications. MODIS also includes a new Enhanced Vegetation Index (EVI) that minimizes canopy background variations and maintains sensitivity over dense vegetation conditions. The EVI also uses the blue band to remove residual atmosphere contamination caused by smoke and sub-pixel thin clouds. The MODIS NDVI and EVI products are computed from atmospherically corrected bi-directional surface reflectances that have been masked for water, clouds, heavy aerosols, and cloud shadows.

Vegetation indices are used for global monitoring of vegetation conditions and are used in products displaying land cover and land cover changes. 
We will work with the MODIS NDVI band within the MOD13Q1 product. More information about this MODIS data set can be found via the [MODIS product table].

```{block, type="alert alert-success"}
> **Question 1**: Now go to the [MODIS MOD13Q1 information](https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mod13q1_v006) page. \See the Data Layer Characteristics page. By what factor does the 250 m MODIS 16 days NDVI image layer need to 
be multiplied in order to obtain values between 0 and 1?
```

```{block, type="alert alert-success"}
> **Question 2**: What pixel reliability (i.e. rank number) would you use to obtain *good data*? Tip: see the [MODIS user guide](https://lpdaac.usgs.gov/sites/default/files/public/product_documentation/mod13_user_guide.pdf) and search for the meaning of reliability (See Table 4).
```

Now go to the [MODIS Land Products](https://modis.ornl.gov/sites/):

  * Search for 'Netherlands' and select the 'Gelderland Loobos' Site.
  * Select the MODIS 13Q1 product by clicking on it.There is no immediate need to create an account unless you want to manually download the MODIS data via this website. In this tutorial we will download MODIS NDVI data via an R script as explained below.
  * Under 'Download data' tab and table you can see the **Pixel Numbering Scheme** where the blue pixel (i.e. 545) is the "site pixel" (i.e. the middle of the spatial subset).

```{block, type="alert alert-success"}
> **Question 3**: What is the key land cover type in the center of the site? (see bottom left side of the website: **land cover**)
```

# Automated MODIS NDVI download and analysis via R

We will download the MODIS data for the Loobos Site via R and process the data for one location to detect changes within the time series.

If it is the first time that you work with R or Rstudio, you can follow the following tutorial on getting started with [R and Rstudio](https://geoscripting-wur.github.io/Scripting4GeoIntro/#Basic_R_and_RStudio_setup).


## Getting started: install packages and define functions for MODIS data analysis

Now we are ready to get started with the MODIS time series analysis exercise in R! 

First, choose your working directory (i.e. a folder on your hard drive) to which the MODIS data will be downloaded and where you will save your R script.
```{block type="alert alert-info"}
**Protip**: Do not hardcode `setwd()` in your R script as the path might be different on another computer, and therefore your script will not be fully reproducible by others.
```

In RStudio you can set your working directory this way, if you have saved your R script to your working directory:
![](figs/setwd_rstudiotip.png)

Check your working directory by

```{r, eval = FALSE}
getwd() # check if you working directory is correctly set
```

Second, make sure your package installed in R are up-to-date by:

```{r, eval=FALSE, echo=TRUE}
update.packages(ask=FALSE)

## we install the latest bfast package from the R-forge website
install.packages("bfast", dependencies=TRUE)

## for mac users you can do
install.packages("bfast", 
                 dependencies=TRUE, type = "source")

```

The necessary add-on packages need to be installed within R before loading the using the `library()` function. Below we define a helper function that does installing and loading of the packages for us. 

```{r, echo=TRUE, message=FALSE, eval=TRUE}
# pkgTest is a helper function to load packages and install packages only when they are not installed yet.
pkgTest <- function(x)
{
  if (x %in% rownames(installed.packages()) == FALSE) {
    install.packages(x, dependencies= TRUE)    
  }
  library(x, character.only = TRUE)
}
neededPackages <- c("strucchange","zoo", "bfast", "MODISTools")
for (package in neededPackages){pkgTest(package)}
```


## Downloading MODIS data using the MODISTools package


```{r, message = FALSE, results='hide'}
library(MODISTools)
library(ggplot2)
library(bfast)

# Create directories if they do not exist yet
if (!dir.exists('data')){
  dir.create('data', showWarnings = FALSE)
}

# see ?mt_subset for more info
subset <- mt_subset(product = "MOD13Q1",
                  site_id = "nl_gelderland_loobos",
                  band="250m_16_days_EVI",
                  start = "2015-01-01",
                  internal = TRUE
                    )
```

Now let's visualise the results using the ggplot package:

```{r}
# visualise the data quicly using ggplot
ggplot(subset[subset$pixel==1,], aes(as.Date(calendar_date),value, colour=band)) + geom_line()
```

# Apply BFASTmonitor

## create a time series

## clean the time series

## apply bfastmonitor

```{r}
#rough draft script to be split up in different sections
#create time series
timeser <- function(index,dt) {
	z <- zoo(index,dt)
	yr <- as.numeric(format(time(z), "%Y"))
	jul <- as.numeric(format(time(z), "%j"))
	delta <- min(unlist(tapply(jul, yr, diff))) # 16
	zz <- aggregate(z, yr + (jul - 1) / delta / 23)
	(tso <- as.ts(zz))
	return(tso)
}

library(zoo)
datapixel1 <- subset[subset$pixel==1,]
tspixel1 <- timeser(datapixel1$value, as.Date(datapixel1$modis_date,"A%Y%j"))
plot(tspixel1)

#apply bfast
library(bfast)
bfmpixel1 <- bfastmonitor(tspixel1, start = c(2018,4))
plot(bfmpixel1)

```


## define some new questions and challenges for the AEO exercise.

Is 2018 abnormal?
Try out different bfastmonitor settings?



# Run the script for another site


# More information
More information can be found on the [BFAST website](http://bfast.r-forge.r-project.org/) and in the BFAST papers mentioned on the website.


<br><br>
<br><br>
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.



